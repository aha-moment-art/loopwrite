<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>🎧 YouTube 听写工具</title>
  <style>
    :root {
      --main-bg: #f4f0fa;
      --panel-bg: #ffffff;
      --primary: #a88adb;
      --primary-dark: #8a6dc4;
      --text: #333;
      --input-bg: #f8f4ff;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: var(--main-bg);
      color: var(--text);
      padding: 30px;
    }

    h1 {
      color: var(--primary-dark);
      text-align: center;
      margin-bottom: 30px;
    }

    #top-bar {
      background-color: var(--panel-bg);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      flex-wrap: nowrap;
      gap: 12px;
      align-items: center;
      justify-content: center;
      overflow-x: auto;
    }

    #youtube-url {
      flex: 2 1 400px;
      min-width: 320px;
      max-width: 600px;
    }

    #top-bar input,
    #top-bar select,
    #top-bar button {
      flex: 0 0 auto;
      padding: 10px 14px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: var(--input-bg);
      box-sizing: border-box;
      height: 42px;
    }

    #top-bar select,
    #top-bar .time-input {
      width: 120px;
    }

    #top-bar button {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100px;
    }

    #top-bar button:hover {
      background-color: var(--primary-dark);
    }

    #container {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    #video-container,
    #input-area {
      flex: 1 1 400px;
      background-color: var(--panel-bg);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
    }

    iframe {
      width: 100%;
      height: 360px;
      border-radius: 8px;
      border: none;
    }

    #input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      margin-top: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: var(--input-bg);
    }

    #output {
      margin-top: 15px;
      background: #fefeff;
      padding: 15px;
      border: 1px dashed var(--primary);
      min-height: 250px;
      white-space: pre-wrap;
      font-size: 17px;
      line-height: 1.6;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
    }

    #clear-btn {
      float: right;
      margin-bottom: 5px;
      background-color: transparent;
      border: none;
      color: var(--primary-dark);
      cursor: pointer;
      font-size: 14px;
    }

    #clear-btn:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>🎧 YouTube 听写工具</h1>

  <div id="top-bar">
    <input type="text" id="youtube-url" placeholder="粘贴 YouTube 链接" />
    <select id="play-seconds">
      <option value="3">播放 3 秒</option>
      <option value="5" selected>播放 5 秒</option>
      <option value="7">播放 7 秒</option>
      <option value="10">播放 10 秒</option>
    </select>
    <button id="start-btn">开始</button>
    <input class="time-input" id="start-time" type="number" min="0" placeholder="起始时间（秒）" />
    <input class="time-input" id="end-time" type="number" min="0" placeholder="结束时间（秒）" />
    <input class="time-input" id="repeat-count" type="number" min="1" value="1" placeholder="重复次数" />
    <button id="focus-btn">专注播放</button>
  </div>

  <div id="container">
    <div id="video-container">
      <div id="player"></div>
    </div>
    <div id="input-area">
      <button id="clear-btn">🗑 清空文本</button>
      <label for="input"><strong>听写输入：</strong> 按下 Enter 播放下一段</label>
      <input id="input" type="text" placeholder="输入一句后按 Enter" autofocus />
      <div id="output"></div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    let player;
    let timeoutId;
    let playDuration = 5000;
    let readyToPlay = false;
    let focusStart = null;
    let focusEnd = null;

    function extractVideoID(url) {
      const regExp = /(?:youtube\.com\/(?:.*v=|.*\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url.match(regExp);
      return match ? match[1] : null;
    }

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '360',
        width: '640',
        videoId: '',
        events: {
          'onReady': () => {
            readyToPlay = true;
          }
        }
      });
    }

    document.getElementById("start-btn").addEventListener("click", () => {
      if (!player || !readyToPlay) {
        alert("播放器尚未就绪，请稍候再试！");
        return;
      }
      const url = document.getElementById("youtube-url").value.trim();
      const videoId = extractVideoID(url);
      playDuration = parseInt(document.getElementById("play-seconds").value, 10) * 1000;
      if (videoId) {
        player.loadVideoById(videoId);
        focusStart = null;
        focusEnd = null;
        setTimeout(() => {
          playSegment();
        }, 1000);
      } else {
        alert("请输入有效的 YouTube 链接！");
      }
    });

    function playSegment() {
      if (!readyToPlay) return;
      clearTimeout(timeoutId);
      if (focusStart !== null && focusEnd !== null) {
        player.seekTo(focusStart);
        player.playVideo();
        timeoutId = setTimeout(() => {
          player.pauseVideo();
        }, (focusEnd - focusStart) * 1000);
      } else {
        player.playVideo();
        timeoutId = setTimeout(() => {
          player.pauseVideo();
        }, playDuration);
      }
    }

    document.getElementById("focus-btn").addEventListener("click", () => {
      focusStart = parseInt(document.getElementById("start-time").value) || 0;
      focusEnd = parseInt(document.getElementById("end-time").value) || 0;
      const repeat = parseInt(document.getElementById("repeat-count").value) || 1;

      if (focusEnd <= focusStart) {
        alert("结束时间必须大于起始时间");
        return;
      }

      let count = 0;

      function repeatPlay() {
        if (count >= repeat) return;
        player.seekTo(focusStart);
        player.playVideo();
        timeoutId = setTimeout(() => {
          player.pauseVideo();
          count++;
          setTimeout(repeatPlay, 500);
        }, (focusEnd - focusStart) * 1000);
      }

      repeatPlay();
    });

    document.getElementById("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        const line = e.target.value.trim();
        if (line) {
          document.getElementById("output").textContent += line + "\n";
        }
        e.target.value = "";
        e.preventDefault();
        playSegment();
      }
    });

    document.getElementById("clear-btn").addEventListener("click", () => {
      document.getElementById("output").textContent = "";
    });
  </script>
</body>
</html>
